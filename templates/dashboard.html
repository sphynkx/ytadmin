<!DOCTYPE html>
<html>
<head>
    <title>YTAdmin Dashboard</title>
    <style>
        body { font-family: Consolas, monospace; background: #222; color: #eee; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        .status-box { padding: 15px; background: #333; border-radius: 5px; margin-bottom: 20px; }
        .healthy { color: #4caf50; font-weight: bold; }
        .unhealthy { color: #f44336; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background-color: #333; }
        a { color: #88ceeb; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Control Plane: {{ username }}</h2>
        <a onclick="logout()">Logout</a>
    </div>

    <div class="status-box">
        <div>Current Status: <span id="mainStatus" class="unhealthy">LOADING...</span></div>
        <div style="font-size: 0.8em; color: #aaa; margin-top: 5px;" id="statusDetails"></div>
    </div>

    <h3>Events History</h3>
    <table id="historyTable">
        <thead><tr><th>Time</th><th>Result</th><th>Details</th></tr></thead>
        <tbody></tbody>
    </table>

    <script>
        async function logout() {
            await fetch('/logout', { method: 'POST' });
            window.location.reload();
        }

        async function refresh() {
            const sReq = await fetch('/api/health/current');
            if (sReq.ok) {
                const sData = await sReq.json();
                const el = document.getElementById('mainStatus');
                el.innerText = sData.healthy ? "HEALTHY" : "DOWN";
                el.className = sData.healthy ? "healthy" : "unhealthy";
                document.getElementById('statusDetails').innerText = JSON.stringify(sData.details);
            }

            const hReq = await fetch('/api/health/history');
            if (hReq.ok) {
                const hData = await hReq.json();
                const tbody = document.querySelector('#historyTable tbody');
                tbody.innerHTML = '';
                hData.forEach(row => {
                    const tr = document.createElement('tr');
                    const color = row.healthy ? 'healthy' : 'unhealthy';
                    tr.innerHTML = `<td>${row.created_at}</td><td class="${color}">${row.status_code}</td><td>${row.error_message || row.details_json || ''}</td>`;
                    tbody.appendChild(tr);
                });
            }
        }
        
        refresh();
        setInterval(refresh, 5000);
    </script>
</body>
</html>