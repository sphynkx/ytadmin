<!DOCTYPE html>
<html>
<head>
    <title>Targets Management</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #e1e4e8; 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        h2 { margin: 0; font-weight: 500; }
        a.logout-btn { 
            color: #0366d6; 
            cursor: pointer; 
            text-decoration: none; 
            font-size: 0.9em;
            border: 1px solid #e1e4e8;
            padding: 5px 10px;
            border-radius: 4px;
            background: white;
        }
        a.logout-btn:hover { background-color: #f3f4f6; text-decoration: none; }

        .targets-bar {
            display: flex; gap: 8px; align-items: center; margin-bottom: 16px;
        }
        .targets-bar input, .targets-bar button {
            font-size: 0.9rem;
            padding: 8px;
        }
        .targets-bar input {
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .targets-bar button {
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }
        .targets-bar button:hover { background-color: #f3f4f6; }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: #ffffff; 
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        th, td { 
            border-bottom: 1px solid #e1e4e8; 
            padding: 12px 15px; 
            text-align: left; 
        }
        th { 
            background-color: #f8f9fa; 
            color: #586069; 
            font-weight: 600; 
            font-size: 0.9em;
            text-transform: uppercase;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fcfcfc; }
        .btn-del {
            color: #dc3545;
            cursor: pointer;
            border: 1px solid #e1e4e8;
            padding: 4px 8px;
            border-radius: 4px;
            background: white;
        }
        .btn-del:hover { background-color: #fde8e8; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Targets Management</h2>
        <a class="logout-btn" onclick="logout()">Sign out</a>
    </div>

    <div class="targets-bar">
        <input id="hostInput" placeholder="Host (e.g., 127.0.0.1)" />
        <input id="portInput" type="number" placeholder="Port (e.g., 50051)" />
        <input id="keyInput" placeholder="Key (optional)" />
        <button onclick="addTarget()">Add target</button>
    </div>

    <table>
        <thead><tr><th>ID</th><th>Host</th><th>Port</th><th>Key</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="targetsBody"></tbody>
    </table>

    <script>
        async function fetchWithAuth(url, opts) {
            const resp = await fetch(url, opts);
            if (resp.status === 401) {
                window.location.href = '/';
                return null;
            }
            return resp;
        }

        async function logout() {
            await fetch('/logout', { method: 'POST' });
            window.location.reload();
        }

        async function addTarget() {
            const host = document.getElementById('hostInput').value.trim();
            const port = parseInt(document.getElementById('portInput').value, 10);
            const key = document.getElementById('keyInput').value.trim();
            if (!host || !port) {
                alert('Host and port are required');
                return;
            }
            const url = `/api/targets?host=${encodeURIComponent(host)}&port=${encodeURIComponent(port)}${key ? `&key=${encodeURIComponent(key)}` : ''}`;
            const resp = await fetchWithAuth(url, { method: 'POST' });
            if (resp && resp.ok) {
                document.getElementById('hostInput').value = '';
                document.getElementById('portInput').value = '';
                document.getElementById('keyInput').value = '';
                refresh();
            } else {
                alert('Failed to add target');
            }
        }

        async function deleteTarget(id) {
            const resp = await fetchWithAuth(`/api/targets/${id}`, { method: 'DELETE' });
            if (resp && resp.ok) {
                refresh();
            } else {
                alert('Failed to delete target');
            }
        }

        async function refresh() {
            const resp = await fetchWithAuth('/api/targets');
            if (!resp || !resp.ok) return;
            const data = await resp.json();
            const tbody = document.getElementById('targetsBody');
            tbody.innerHTML = '';
            data.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id}</td>
                    <td>${t.host}</td>
                    <td>${t.port}</td>
                    <td>${t.key || ''}</td>
                    <td>${t.created_at || ''}</td>
                    <td><button class="btn-del" onclick="deleteTarget(${t.id})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        refresh();
    </script>
</body>
</html>